= 카프카 산전수전 노하우

https://tv.kakao.com/channel/3150758/cliplink/391419257[카프카 산전수전 노하우 2018.10.10]

https://www.slideshare.net/ifkakao/ss-113145591[카프카, 산전수전 노하우]

카프카, 데이터 플랫폼의 최강자 저자


.오늘 나눌 이야기
* 카프카의 현황
* 트러블 슈팅
** Shrinking ISR
** Rack Power
* 프로듀서와 컨슈머
* 운영

== 카프카의 현황
프로듀서, 카프카, 주키퍼, 컨슈머

분산코디네이터시스템인 주키퍼

메타데이터 관리, 클러스터 노드 관리를 주키퍼를 통해서 하고 있음

주키퍼 쿼럼방식이라 홀수.

카프카 최소 3대면 좋음

사용량 많아서 증설해야 되면 주키퍼는 그대로. 카프카만 5대, 10대... 늘려주면 됨.

(오픈) 2클러스터/10EA -> (현재) 7클러스터/130EA

IDC마다 주키퍼 세트

7클러스터

하루에 2600억개의 메시지 처리. 초당 300만건 정도를 취지 않고 처리

240 TB / day 들어오고

370 TB / day 나감

가동률 99.99%
1시간/2년

운영한지 2년. 이슈 2건 1시간.

== 트러블슈팅
2가지 이슈

1. Shrinking ISR

== ISR이란?
* In-Sync Replicas(ISR)
* 리플리케이션 구성원은 리더와 팔로워
* 리더만 읽고 쓰기
* 팔로워들은 리더를 주기적으로 동기화
* ISR의 구성원만이 리더의 자격을 갖는다.


ISR이 축소되는게 Shrinking ISR


메시지가 잘 안가요. 잘 안받아져요.

서버 다운된거 없이 질 동작하고 있었음.

INFO, WARNING, ERROR

INFO Partition ... Shrinking ISR for partition ... from 3,4,5 to 5 (kafka.cluster.Partition)

0.10.1.0 버그

상위버전에서 버그가 픽스 되었음.

== 카프카 버전 업그레이드
* 다운타임을 가질 수 있는 환경
** 전체 브로커 종료 후 버전 업그레이드 진행
* 다운타임을 가질 수 없는 환경
** 클러스터내 브러코 한대씩 버전 업그레이드를 진행
* 카카오에서는..
** 크리티컬 이슈가 발생하거나 신규 기능이 추가되는 경우 다운타임없이 버전 업그레이드 진행

== 2. Rack Power

서버마다 broker분산

=== 모든 브로커 다운
Broker1 A
Broker2 A,B
Broker3 A,B,C

모두 다운

Broker1가 먼저 올라오면

메시지 B, C 유실

서비스의 영속성, 데이터 정합성 어떤것을 우선시 할 것인가.

영속성을 우선시 해서 데이터 손실. 빠른 투입 가능.

== 프로듀서와 컨슈머

=== 프로듀서

* 프로듀서는 파티션의 리더로 직ㅈ버 메시지를 전송
* 특정 파티션 또는 랜덤 파티션으로 전송
* 빠른 전송 속도 보장
* 효율성이 좋은 배치 처리 가능
* 설정을 통해 배치 크기나 지연시간 조정

== 프로듀서 ACKS
* ACKS=0
** 매우 빠르게 전송할 수 있지만, 파티션의 리더가 받았는지 알 수 없음
* ACKS=1 (Strongly Recommend)
** 메시지 전송도 빠른편이고, 파티션의 리더가 받았는지 확인
** 가장 많이 사용되고, 최근 대부분의 기본값으로 사용
* ACKS=ALL
** 메시지 전송 속도는 가장 느리지만, 손실 없는 메시지 전송 가능
** 팔로도워도 메시지를 받았는지 확인하기 때문에 느림


특정 파티션이 이상해요.. 문제 있나요?

한쪽 파티션으로 메시지들이 몰리는 상황
프로듀서에 KEY 옵션을 넣어서 사용하고 있었음

Key를 빼면 Key: None
라운드로빈으로 균등하게 분배


== 2. 컨슈머

.컨슈머
* 컨슈머는 파티션의 리더에게 "fetch" 요청을 하는 역할
* 컨슈머는 위치를 기록하고 있는 오프셋으로부터 메시지를 가져온다.
* 컨슈머의 목적은 컨슈머가 가능한 최대 속도로 가져갈 수 있도록 하는 것

파티션의 오프셋 순서대로
파티션이 하나이면 순서보장

하나의 토픽을 여러개의 파티션으로 나눠서 사용하는게 일반적
파티션의 오프셋 순서대로. 파티션별로 순서대로 가져오지만 파티션 순서는 고려하지 않음.
순서가 꼬일 수 있음.
메시지에 타임스탬프 넣어서 순서대로 저장하면 순서를 보장 할 수 있음.

.컨슈머 그룹
* 하나의 토픽을 여러 컨슈머들이 구독
* 컨슈머 그룹으로 그룹핑하여 컨슈머를 확장할 수 있다.
* 프로듀서가 토픽으로 보내는 메시지 비율을 높인다면?
* 컨슈머는 프로듀서의 속도를 따라가지 못하게 된다.

하나의 파티션에는 하나의 컨슈머만 가능
1:1로 매핑. 컨슈머만 늘리면 컨슈머 놀고 있음.

컨슈머 그룹을 이용한 멀티 컨슈머


LAG이 뭔가요?

10개 프로듀스, 10개 컨슘. LAG=0
10개 프로듀스, 5개 컨슘. LAG=5

얼마나 밀리지 않고 가져가고 있는지.

== Burrow
* 카프카 컨슈머 Lag Checking
* HTTP
* Go
* https://github.com/linkedin/Burrow


== 운영

=== 미사용 토픽
토픽 수가 늘기만 하는데, 좋은 방법은 없을까?

JMX로 토픽 상태값을 수집 저장 후 조건에 일치하는 토픽 삭제

일정 기간 사용하지 않는 토픽 삭제

이렇게 해도 중요한 토픽을 삭제 하게 될 수도 있음.

삭제하기 며칠전입니다. 알람을 줌.

== 마무리
* 브로커의 로그
* 서비스 영속성, 데이터 정합성
* 프로듀서
* 컨슈머
* 좋은 애플리케이션인 카프카를 적극 활용!!


질문

1. 클러스터 나누는 기준?
링크드인: 하나의 클러스터에 60개 브로커

30개 운영하다 보니 버전 업그레이드라던지 설정 바꿔야 되는 경우 롤링 리스타트 너무 많음

꽉 차면 별도 클러스터 운영

2. 버전 업그레이드시 중단해야 되는 경우

중단 할 수 없음. 최대한 테스트

3. 카카오 베스트 프렉틱스?
지금 하는게 베스트 프렉틱스

여러가지로 테스트 하고 있음. 정리 되면 베스트 프렉티스 공유 할 수 있으면 좋겠음.

4. 적정한 토픽 수?
서버 댓수나 스펙에 따라 다를 수 있음.
500개 미만.

2000~3000개 직접 운영하시는 분이 부하 있다고 함.

5. RabbitMQ사용중이다. 순서 보장 되어야 되는 경우 Kafka 추천?
Kafka사용. 하나의 토픽 사용하면 순서 보장. 원하시는 기능 사용할 수 있음.
Kafka 쓰루풋 좋음.
굳이 RabbitMQ문제 없으면 그냥 사용. 기능도 더 많음.


== References
https://docs.google.com/document/d/17dDcfkM_7SeSfxqEU-iqeOHjCgvvmHZZtI1V3DQOHLY/edit#[if(kakao)2018 카프카, 산전수전 노하우]
